<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexCall — Private Video</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#080c14">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg:        #080c14;
            --surface:   #0f1623;
            --surface2:  #161e2e;
            --surface3:  #1e2a40;
            --border:    rgba(99,179,255,0.1);
            --accent:    #3b82f6;
            --accent2:   #06b6d4;
            --danger:    #ef4444;
            --success:   #10b981;
            --warning:   #f59e0b;
            --text:      #f0f6ff;
            --text2:     #7a9cc4;
            --text3:     #3d5a80;
            --glow:      rgba(59,130,246,0.35);
            --glow2:     rgba(6,182,212,0.2);
            --radius:    16px;
            --radius-sm: 10px;
            --font:      'DM Sans', sans-serif;
            --mono:      'Space Mono', monospace;
        }

        html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); -webkit-tap-highlight-color: transparent; }

        body::before {
            content: '';
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
            background:
                radial-gradient(ellipse 80% 60% at 10% 0%,  rgba(59,130,246,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 50% at 90% 100%, rgba(6,182,212,0.06)  0%, transparent 60%);
        }

        /* ── PAGES ──────────────────────────────────── */
        .page { display: none; position: fixed; inset: 0; z-index: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .page.active { display: flex; }

        /* ── LANDING ─────────────────────────────────── */
        #landing-page { flex-direction: column; align-items: center; justify-content: center; padding: 24px; }

        .brand { text-align: center; margin-bottom: 48px; animation: riseIn .7s cubic-bezier(.22,1,.36,1) both; }

        .brand-icon {
            width: 80px; height: 80px; margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 24px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 40px var(--glow), 0 0 80px var(--glow2);
            animation: pulseGlow 3s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%,100% { box-shadow: 0 0 40px var(--glow), 0 0 80px var(--glow2); }
            50%      { box-shadow: 0 0 60px var(--glow), 0 0 120px var(--glow2); }
        }

        .brand h1 {
            font-family: var(--mono); font-size: clamp(28px,6vw,40px); letter-spacing:-1px;
            background: linear-gradient(135deg,#fff 30%,var(--accent2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .brand p { margin-top: 8px; color: var(--text2); font-size: 14px; letter-spacing:.5px; }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; width: 100%; max-width: 420px; animation: riseIn .7s cubic-bezier(.22,1,.36,1) .1s both; backdrop-filter: blur(20px); }
        .card-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text2); margin-bottom: 16px; }

        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 15px 20px; border: none; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: transform .15s, box-shadow .2s; }
        .btn:active { transform: scale(.97); }
        .btn-primary { background: linear-gradient(135deg,var(--accent),#2563eb); color:#fff; box-shadow: 0 4px 20px rgba(59,130,246,.4); }
        .btn-primary:hover { box-shadow: 0 6px 28px rgba(59,130,246,.55); }
        .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--surface3); }

        .divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: var(--text3); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .divider::before,.divider::after { content:''; flex:1; height:1px; background: var(--border); }

        .input-field { width:100%; padding:15px 18px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size:20px; font-family: var(--mono); letter-spacing:6px; text-align:center; transition: border-color .2s, box-shadow .2s; margin-bottom:12px; }
        .input-field:focus { outline:none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
        .input-field::placeholder { color: var(--text3); letter-spacing:2px; font-size:14px; font-family: var(--font); }

        .badges { display:flex; justify-content:center; gap:16px; margin-top:24px; flex-wrap:wrap; }
        .badge { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text3); font-weight:500; }

        /* ── CALL PAGE ───────────────────────────────── */
        #call-page { flex-direction:column; background: var(--bg); }

        /* Header */
        .call-header {
            flex-shrink:0; display:flex; align-items:center; justify-content:space-between;
            padding: 10px 16px; padding-top: max(10px, env(safe-area-inset-top));
            background: rgba(8,12,20,.88); backdrop-filter:blur(16px);
            border-bottom: 1px solid var(--border); z-index:50; gap:10px;
        }
        .header-left { display:flex; align-items:center; gap:10px; }
        .header-logo { width:32px; height:32px; background: linear-gradient(135deg,var(--accent),var(--accent2)); border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .room-chip { display:flex; align-items:center; gap:8px; background: var(--surface2); border:1px solid var(--border); border-radius:40px; padding:6px 14px; }
        .room-chip-label { color:var(--text2); font-size:12px; }
        .room-chip-code { font-family:var(--mono); font-size:16px; font-weight:700; color:var(--accent2); letter-spacing:2px; }
        .header-right { display:flex; align-items:center; gap:8px; }

        .icon-btn { position:relative; width:38px; height:38px; background: var(--surface2); border:1px solid var(--border); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: background .2s, color .2s, transform .15s; color: var(--text2); }
        .icon-btn:hover { background: var(--surface3); color: var(--text); }
        .icon-btn:active { transform: scale(.92); }
        .icon-btn.active { background: var(--accent); border-color: var(--accent); color:#fff; }

        /* Chat badge */
        .chat-badge {
            position:absolute; top:-4px; right:-4px;
            background: var(--danger); color:#fff; font-size:10px; font-weight:700; font-family:var(--mono);
            min-width:18px; height:18px; border-radius:9px; padding:0 4px; border:2px solid var(--bg);
            display:none; align-items:center; justify-content:center;
            animation: badgePop .3s cubic-bezier(.22,1,.36,1);
        }
        .chat-badge.show { display:flex; }
        @keyframes badgePop { from{transform:scale(0)} to{transform:scale(1)} }

        .participants-chip { display:flex; align-items:center; gap:6px; background:var(--surface2); border:1px solid var(--border); border-radius:40px; padding:6px 12px; color:var(--text2); font-size:13px; font-weight:600; }
        .participants-chip .pcount { color:var(--accent); }

        /* ── DYNAMIC VIDEO GRID ─────────────────────── */
        #video-grid {
            flex:1; display:grid; gap:6px; padding:6px;
            overflow:hidden; min-height:0;
            transition: grid-template-columns .4s cubic-bezier(.22,1,.36,1), grid-template-rows .4s cubic-bezier(.22,1,.36,1);
        }

        /* Layout classes set by JS */
        #video-grid.layout-1 { grid-template-columns:1fr; grid-template-rows:1fr; }
        #video-grid.layout-2 { grid-template-columns:1fr 1fr; grid-template-rows:1fr; }
        #video-grid.layout-3 { grid-template-columns:1fr 1fr; grid-template-rows:1.15fr 1fr; }
        #video-grid.layout-3 .video-container:first-child { grid-column: 1 / -1; }
        #video-grid.layout-4 { grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; }
        #video-grid.layout-5 { grid-template-columns:repeat(3,1fr); grid-template-rows:1fr 1fr; }
        #video-grid.layout-5 .video-container:nth-child(1) { grid-column: 1 / 2; }
        #video-grid.layout-5 .video-container:nth-child(2) { grid-column: 2 / 4; }
        #video-grid.layout-many { grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }

        @media (max-width:600px) {
            #video-grid.layout-2 { grid-template-columns:1fr; grid-template-rows:1fr 1fr; }
            #video-grid.layout-3, #video-grid.layout-4 { grid-template-columns:1fr; }
            #video-grid.layout-3 .video-container:first-child { grid-column: auto; }
            #video-grid.layout-5 { grid-template-columns:1fr 1fr; }
            #video-grid.layout-5 .video-container:nth-child(1),
            #video-grid.layout-5 .video-container:nth-child(2) { grid-column: auto; }
        }

        /* Video card */
        .video-container {
            position:relative; background:var(--surface); border-radius:14px; overflow:hidden;
            border:1.5px solid var(--border); box-shadow: 0 4px 24px rgba(0,0,0,.5);
            transition: border-color .3s;
            animation: cardIn .4s cubic-bezier(.22,1,.36,1) both;
        }
        @keyframes cardIn { from{opacity:0;transform:scale(.93)} to{opacity:1;transform:scale(1)} }
        .video-container.local-video { border-color: rgba(59,130,246,.4); }
        .video-container video { width:100%; height:100%; object-fit:cover; display:block; background:#000; transition: opacity .3s; }
        .local-video video { transform: scaleX(-1); }
        .video-container.video-off video { opacity:0; }

        /* Avatar overlay */
        .av-overlay {
            position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
            background: var(--surface); opacity:0; pointer-events:none; transition: opacity .3s;
        }
        .video-off .av-overlay { opacity:1; }
        .av-circle { width:60px; height:60px; border-radius:50%; background: var(--surface3); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; color:var(--text2); }

        /* Name tag */
        .name-tag { position:absolute; bottom:10px; left:10px; display:flex; align-items:center; gap:6px; background:rgba(8,12,20,.78); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.07); padding:5px 10px 5px 8px; border-radius:24px; font-size:12px; font-weight:600; z-index:10; max-width:calc(100% - 60px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

        /* Mute badge */
        .mute-badge { position:absolute; top:10px; right:10px; width:30px; height:30px; background:rgba(8,12,20,.78); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.07); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:10; color:var(--text2); transition: background .2s; }
        .mute-badge.muted { background:rgba(239,68,68,.85); color:#fff; }

        /* Quality bars */
        .quality-bar { position:absolute; top:10px; left:10px; display:flex; align-items:flex-end; gap:2px; background:rgba(8,12,20,.78); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.07); padding:6px 8px; border-radius:8px; z-index:10; }
        .quality-bar .bar { width:4px; border-radius:2px; background:var(--text3); transition: background .3s, height .3s; }
        .quality-bar .bar:nth-child(1){height:5px} .quality-bar .bar:nth-child(2){height:9px} .quality-bar .bar:nth-child(3){height:13px} .quality-bar .bar:nth-child(4){height:17px}
        .quality-bar[data-quality="1"] .bar:nth-child(1)        { background:var(--danger); }
        .quality-bar[data-quality="2"] .bar:nth-child(-n+2)     { background:var(--warning); }
        .quality-bar[data-quality="3"] .bar:nth-child(-n+3)     { background:var(--accent); }
        .quality-bar[data-quality="4"] .bar                     { background:var(--success); }

        /* PiP */
        .pip-btn { position:absolute; bottom:10px; right:10px; width:28px; height:28px; background:rgba(8,12,20,.78); border:1px solid rgba(255,255,255,.07); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10; color:var(--text2); opacity:0; transition: opacity .2s, background .2s; }
        .video-container:hover .pip-btn { opacity:1; }
        .pip-btn:hover { background:var(--accent); color:#fff; }

        /* Empty state */
        .grid-empty { grid-column:1/-1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; color:var(--text3); padding:40px; text-align:center; }
        .grid-empty h3 { font-size:16px; color:var(--text2); }
        .grid-empty p  { font-size:14px; line-height:1.6; }

        /* ── CONTROLS ──────────────────────────────── */
        .call-controls { flex-shrink:0; display:flex; align-items:center; justify-content:center; gap:10px; padding:12px 20px; padding-bottom:max(12px,env(safe-area-inset-bottom)); background:rgba(8,12,20,.92); backdrop-filter:blur(16px); border-top:1px solid var(--border); flex-wrap:wrap; }

        .ctrl-btn { display:flex; flex-direction:column; align-items:center; gap:5px; padding:10px 14px; border:none; border-radius:var(--radius-sm); background:var(--surface2); border:1px solid var(--border); color:var(--text2); cursor:pointer; font-family:var(--font); font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; min-width:62px; transition: background .2s, border-color .2s, color .2s, transform .15s, box-shadow .2s; }
        .ctrl-btn:active { transform:scale(.94); }
        .ctrl-btn.on  { background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.4); color:var(--accent); }
        .ctrl-btn.off { background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:var(--danger); }
        .ctrl-btn.danger { background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.38); color:var(--danger); }
        .ctrl-btn.danger:hover { background:var(--danger); color:#fff; border-color:var(--danger); box-shadow:0 4px 20px rgba(239,68,68,.4); }
        .ctrl-btn.cam-switch { display:none; }
        .ctrl-btn.cam-switch.visible { display:flex; }

        /* ── CHAT PANEL ─────────────────────────────── */
        .chat-panel { position:fixed; right:0; top:0; bottom:0; width:min(360px,100vw); background:var(--surface); border-left:1px solid var(--border); display:flex; flex-direction:column; z-index:200; transform:translateX(100%); transition:transform .35s cubic-bezier(.22,1,.36,1); box-shadow:-8px 0 40px rgba(0,0,0,.5); }
        .chat-panel.open { transform:translateX(0); }
        .chat-head { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
        .chat-head h3 { font-size:15px; font-weight:700; display:flex; align-items:center; gap:8px; }
        .chat-panel-count { background:var(--accent); color:#fff; font-size:11px; font-weight:700; padding:2px 7px; border-radius:10px; font-family:var(--mono); }
        .chat-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scrollbar-width:thin; scrollbar-color:var(--surface3) transparent; }
        .msg { max-width:78%; padding:10px 14px; border-radius:16px; align-self:flex-start; background:var(--surface2); border:1px solid var(--border); word-break:break-word; animation:msgIn .3s cubic-bezier(.22,1,.36,1); }
        .msg.own { align-self:flex-end; background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.3); }
        @keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        .msg-sender { font-size:11px; font-weight:700; color:var(--text2); margin-bottom:3px; }
        .msg-text   { font-size:14px; line-height:1.45; }
        .msg-time   { font-size:10px; color:var(--text3); margin-top:4px; text-align:right; font-family:var(--mono); }
        .chat-input-wrap { padding:14px 16px; border-top:1px solid var(--border); display:flex; gap:8px; align-items:center; }
        #chat-input { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:24px; padding:10px 16px; color:var(--text); font-size:14px; font-family:var(--font); transition: border-color .2s; }
        #chat-input:focus { outline:none; border-color:var(--accent); }
        #chat-input::placeholder { color:var(--text3); }
        #send-chat { width:40px; height:40px; background:var(--accent); border:none; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#fff; flex-shrink:0; transition: background .2s, transform .15s; }
        #send-chat:hover { background:#2563eb; }
        #send-chat:active { transform:scale(.9); }

        /* ── CAMERA MODAL ───────────────────────────── */
        .cam-modal { position:fixed; inset:0; z-index:300; display:flex; align-items:flex-end; justify-content:center; padding:16px; background:rgba(0,0,0,.72); backdrop-filter:blur(6px); opacity:0; pointer-events:none; transition:opacity .3s; }
        .cam-modal.open { opacity:1; pointer-events:all; }
        .cam-sheet { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:8px; width:100%; max-width:400px; transform:translateY(20px); transition:transform .35s cubic-bezier(.22,1,.36,1); }
        .cam-modal.open .cam-sheet { transform:translateY(0); }
        .cam-sheet-head { display:flex; align-items:center; justify-content:space-between; padding:12px 16px 8px; color:var(--text2); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
        .cam-opt { display:flex; align-items:center; gap:12px; padding:13px 16px; border-radius:12px; cursor:pointer; transition:background .15s; font-size:14px; font-weight:500; }
        .cam-opt:hover { background:var(--surface2); }
        .cam-opt.selected { background:rgba(59,130,246,.15); color:var(--accent); }
        .cam-opt-icon { width:36px; height:36px; border-radius:10px; background:var(--surface2); display:flex; align-items:center; justify-content:center; color:var(--text2); flex-shrink:0; }
        .cam-opt.selected .cam-opt-icon { background:rgba(59,130,246,.2); color:var(--accent); }

        /* ── UTILITIES ──────────────────────────────── */
        .https-warn { position:fixed; top:0;left:0;right:0; background:var(--danger); color:#fff; text-align:center; padding:10px; z-index:1000; font-size:13px; font-weight:600; display:none; }
        .https-warn.show { display:block; }

        .reconnect-banner { position:fixed; top:70px; left:50%; transform:translateX(-50%); background:var(--warning); color:#fff; padding:10px 20px; border-radius:40px; font-size:13px; font-weight:600; z-index:150; display:none; align-items:center; gap:10px; box-shadow:0 4px 20px rgba(0,0,0,.4); white-space:nowrap; }
        .reconnect-banner.show { display:flex; }
        .reconnect-banner button { background:rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.4); color:#fff; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700; cursor:pointer; font-family:var(--font); }

        .loading-overlay { position:fixed; inset:0; background:rgba(8,12,20,.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:500; gap:16px; }
        .loader { width:48px; height:48px; border:3px solid var(--surface3); border-top-color:var(--accent); border-radius:50%; animation:spin .9s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .loading-overlay p { color:var(--text2); font-size:15px; font-weight:500; }

        .toast { position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:12px 22px; border-radius:40px; font-size:14px; font-weight:500; z-index:400; box-shadow:0 8px 30px rgba(0,0,0,.5); animation:toastIn .3s cubic-bezier(.22,1,.36,1); max-width:90vw; text-align:center; white-space:nowrap; }
        .toast.important { border-color:var(--warning); color:var(--warning); }
        @keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
        @keyframes riseIn   { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
    </style>
</head>
<body>

<!-- HTTPS Warning -->
<div id="https-warn" class="https-warn">⚠️ HTTPS required for camera & microphone access.</div>

<!-- Reconnect Banner -->
<div id="reconnect-banner" class="reconnect-banner">
    <span id="reconnect-msg">Stream interrupted.</span>
    <button id="reconnect-btn">Reconnect</button>
</div>

<!-- Loading -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loader"></div>
    <p id="loading-msg">Connecting…</p>
</div>

<!-- Camera Selector -->
<div id="cam-modal" class="cam-modal">
    <div class="cam-sheet">
        <div class="cam-sheet-head">
            <span>Select Camera</span>
            <button id="close-cam-modal" class="icon-btn" style="position:static;width:30px;height:30px;">
                <i data-lucide="x" style="width:14px;height:14px;"></i>
            </button>
        </div>
        <div id="cam-list"></div>
    </div>
</div>

<!-- ── LANDING ─────────────────────────────────────────────────── -->
<div id="landing-page" class="page active">
    <div class="brand">
        <div class="brand-icon">
            <i data-lucide="video" style="width:36px;height:36px;color:#fff;"></i>
        </div>
        <h1>NexCall</h1>
        <p>Encrypted · Peer-to-Peer · No account needed</p>
    </div>

    <div class="card">
        <div class="card-title">Start a call</div>
        <button id="create-room" class="btn btn-primary">
            <i data-lucide="plus-circle" style="width:18px;height:18px;"></i>
            Create New Room
        </button>
        <div class="divider">or join existing</div>
        <input type="text" id="room-code" class="input-field" placeholder="Enter 4-digit code" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
        <button id="join-room" class="btn btn-secondary">
            <i data-lucide="log-in" style="width:18px;height:18px;"></i>
            Join Room
        </button>
        <div class="badges">
            <div class="badge"><i data-lucide="shield-check" style="width:13px;height:13px;"></i> Encrypted</div>
            <div class="badge"><i data-lucide="lock"         style="width:13px;height:13px;"></i> No storage</div>
            <div class="badge"><i data-lucide="zap"          style="width:13px;height:13px;"></i> Instant</div>
        </div>
    </div>
</div>

<!-- ── CALL PAGE ───────────────────────────────────────────────── -->
<div id="call-page" class="page">

    <div class="call-header">
        <div class="header-left">
            <div class="header-logo">
                <i data-lucide="video" style="width:16px;height:16px;color:#fff;"></i>
            </div>
            <div class="room-chip">
                <span class="room-chip-label">Room</span>
                <span id="current-room" class="room-chip-code">----</span>
            </div>
        </div>
        <div class="header-right">
            <button id="copy-code-btn" class="icon-btn" title="Copy code">
                <i data-lucide="copy" style="width:16px;height:16px;"></i>
            </button>
            <button id="copy-link-btn" class="icon-btn" title="Copy invite link">
                <i data-lucide="link" style="width:16px;height:16px;"></i>
            </button>
            <button id="toggle-chat-btn" class="icon-btn" title="Chat">
                <i data-lucide="message-square" style="width:16px;height:16px;"></i>
                <span id="chat-badge" class="chat-badge">0</span>
            </button>
            <div class="participants-chip">
                <i data-lucide="users" style="width:14px;height:14px;"></i>
                <span id="participant-count" class="pcount">1</span>
            </div>
        </div>
    </div>

    <div id="video-grid" class="layout-1">
        <div id="grid-empty" class="grid-empty" style="display:none;">
            <i data-lucide="user-plus" style="width:48px;height:48px;color:var(--text3);"></i>
            <h3>Waiting for participants…</h3>
            <p>Share the room code to invite others</p>
        </div>
    </div>

    <div class="call-controls">
        <button id="toggle-mute" class="ctrl-btn on">
            <i data-lucide="mic" style="width:20px;height:20px;"></i>
            <span>Mic</span>
        </button>
        <button id="toggle-video" class="ctrl-btn on">
            <i data-lucide="video" style="width:20px;height:20px;"></i>
            <span>Camera</span>
        </button>
        <button id="switch-cam-btn" class="ctrl-btn cam-switch" title="Switch camera">
            <i data-lucide="camera" style="width:20px;height:20px;"></i>
            <span>Switch</span>
        </button>
        <button id="leave-btn" class="ctrl-btn danger">
            <i data-lucide="phone-off" style="width:20px;height:20px;"></i>
            <span>Leave</span>
        </button>
    </div>
</div>

<!-- ── CHAT PANEL ──────────────────────────────────────────────── -->
<div id="chat-panel" class="chat-panel">
    <div class="chat-head">
        <h3>
            <i data-lucide="message-square" style="width:16px;height:16px;"></i>
            Chat
            <span id="chat-panel-count" class="chat-panel-count">0</span>
        </h3>
        <button id="close-chat" class="icon-btn" style="position:static;">
            <i data-lucide="x" style="width:16px;height:16px;"></i>
        </button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-wrap">
        <input type="text" id="chat-input" placeholder="Send a message…" maxlength="500">
        <button id="send-chat">
            <i data-lucide="send" style="width:16px;height:16px;"></i>
        </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
lucide.createIcons();

// HTTPS check
if (location.protocol !== 'https:' && !['localhost','127.0.0.1'].some(h => location.hostname.includes(h))) {
    document.getElementById('https-warn').classList.add('show');
}

// Firebase (NOTE: enforce Security Rules server-side in production)
const firebaseConfig = {
    apiKey: "AIzaSyDTRGf1kGE2_Kjm457NmRdID0_w_x5h48k",
    authDomain: "video-9335.firebaseapp.com",
    databaseURL: "https://video-9335-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "video-9335",
    storageBucket: "video-9335.firebasestorage.app",
    messagingSenderId: "438743646214",
    appId: "1:438743646214:web:db16a9d5c94820845b8387"
};
let database;
try { firebase.initializeApp(firebaseConfig); database = firebase.database(); } catch(e) { console.error(e); }

// ── Inline SVG helpers (used where Lucide can't be recreated dynamically) ──
const SVG = {
    mic:    `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`,
    micOff: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 005.12 2.12M15 9.34V4a3 3 0 00-5.94-.6"/><path d="M17 16.95A7 7 0 015 12v-2m14 0v2a7 7 0 01-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`,
    user:   `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M6 20c0-4 2.7-6 6-6s6 2 6 6"/></svg>`,
    pip:    `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><rect x="12" y="12" width="8" height="8" rx="1"/></svg>`,
};

class VideoCallApp {
    constructor() {
        this.localStream       = null;
        this.peers             = new Map();
        this.roomId            = null;
        this.userId            = this.getOrCreateUserId();
        this.isAudioMuted      = false;
        this.isVideoMuted      = false;
        this.qualityIntervals  = new Map();
        this.firebaseListeners = [];
        this.totalMessages     = 0;
        this.unreadMessages    = 0;
        this.chatOpen          = false;
        this.cameras           = [];
        this.currentCameraId   = null;
        this.streamHealthInterval = null;
        this.reconnectAttempts    = 0;
        this.maxReconnectAttempts = 3;
        this.reconnectTimeout     = null;

        this.$ = id => document.getElementById(id);
        this.initEls();
        this.bindEvents();
        this.checkUrlForRoom();
        this.setupFirebaseMonitor();
        this.checkForActiveSession();
        this.loadUserPreferences();
        this.enumerateCameras();
    }

    /* ── Cookie helpers ─────────────────────────────────── */
    cookieOpts(exp) {
        const secure = location.protocol === 'https:' && !['localhost','127.0.0.1'].some(h => location.hostname.includes(h));
        return `expires=${exp.toUTCString()}; path=/; SameSite=Strict${secure ? '; Secure' : ''}`;
    }
    getOrCreateUserId() {
        const name = 'video_call_user_id';
        for (const c of document.cookie.split(';')) {
            const [k,v] = c.trim().split('=');
            if (k === name && v) return v;
        }
        const id = 'u_' + Math.random().toString(36).slice(2,11) + '_' + Date.now();
        const exp = new Date(); exp.setDate(exp.getDate()+30);
        document.cookie = `${name}=${id}; ${this.cookieOpts(exp)}`;
        return id;
    }
    checkForActiveSession() {
        for (const c of document.cookie.split(';')) {
            const [k,v] = c.trim().split('=');
            if (k === 'video_call_active_room') {
                try {
                    const d = JSON.parse(decodeURIComponent(v));
                    if (Date.now()-d.timestamp < 300000 && d.roomId) {
                        this.$('room-code').value = d.roomId;
                        this.toast('Previous session found — click Join to reconnect');
                    } else { this.clearSessionCookie(); }
                } catch(e) {}
                break;
            }
        }
    }
    setActiveSession(roomId) {
        const d = { roomId, userId: this.userId, timestamp: Date.now() };
        const exp = new Date(); exp.setHours(exp.getHours()+1);
        document.cookie = `video_call_active_room=${encodeURIComponent(JSON.stringify(d))}; ${this.cookieOpts(exp)}`;
        localStorage.setItem('video_call_active_session', JSON.stringify(d));
    }
    clearUserCookies() {
        for (const c of document.cookie.split(';')) {
            const [k] = c.trim().split('=');
            if (k.startsWith('video_call_')) document.cookie = `${k}=; ${this.cookieOpts(new Date(0))}`;
        }
        ['video_call_active_session','video_call_user_preferences'].forEach(k => localStorage.removeItem(k));
        sessionStorage.clear();
    }
    clearSessionCookie() {
        document.cookie = `video_call_active_room=; ${this.cookieOpts(new Date(0))}`;
        localStorage.removeItem('video_call_active_session');
    }
    savePrefs() {
        localStorage.setItem('video_call_user_preferences', JSON.stringify({ audioMuted: this.isAudioMuted, videoMuted: this.isVideoMuted, timestamp: Date.now() }));
    }
    loadUserPreferences() {
        try {
            const p = JSON.parse(localStorage.getItem('video_call_user_preferences') || 'null');
            if (p && Date.now()-p.timestamp < 604800000) { this.isAudioMuted = !!p.audioMuted; this.isVideoMuted = !!p.videoMuted; }
        } catch(e) {}
    }

    /* ── Camera enumeration ─────────────────────────────── */
    async enumerateCameras() {
        try {
            const tmp = await navigator.mediaDevices.getUserMedia({video:true}).catch(()=>null);
            if (tmp) tmp.getTracks().forEach(t=>t.stop());
            const devs = await navigator.mediaDevices.enumerateDevices();
            this.cameras = devs.filter(d => d.kind === 'videoinput');
            if (this.cameras.length > 1) this.$('switch-cam-btn').classList.add('visible');
        } catch(e) { console.warn('Camera enum failed:', e); }
    }

    /* ── DOM / events ───────────────────────────────────── */
    initEls() {
        this.landingPage     = this.$('landing-page');
        this.callPage        = this.$('call-page');
        this.videoGrid       = this.$('video-grid');
        this.gridEmpty       = this.$('grid-empty');
        this.pCount          = this.$('participant-count');
        this.loadOverlay     = this.$('loading-overlay');
        this.loadMsg         = this.$('loading-msg');
        this.reconnectBanner = this.$('reconnect-banner');
        this.reconnectMsgEl  = this.$('reconnect-msg');
        this.muteBtn         = this.$('toggle-mute');
        this.videoBtn        = this.$('toggle-video');
        this.chatPanel       = this.$('chat-panel');
        this.chatMessages    = this.$('chat-messages');
        this.chatBadge       = this.$('chat-badge');
        this.chatPanelCount  = this.$('chat-panel-count');
    }

    bindEvents() {
        this.$('create-room').onclick    = () => this.createRoom();
        this.$('join-room').onclick      = () => this.joinRoom();
        this.$('room-code').onkeypress   = e => { if (e.key==='Enter') this.joinRoom(); };
        this.$('room-code').oninput      = e => { e.target.value = e.target.value.replace(/\D/g,''); };
        this.$('copy-code-btn').onclick  = () => this.clip(this.roomId, 'Room code copied!');
        this.$('copy-link-btn').onclick  = () => this.copyLink();
        this.$('toggle-chat-btn').onclick= () => this.toggleChat();
        this.$('close-chat').onclick     = () => this.toggleChat();
        this.$('send-chat').onclick      = () => this.sendMessage();
        this.$('chat-input').onkeypress  = e => { if (e.key==='Enter') this.sendMessage(); };
        this.muteBtn.onclick             = () => this.toggleAudio();
        this.videoBtn.onclick            = () => this.toggleVideo();
        this.$('switch-cam-btn').onclick = () => this.openCamModal();
        this.$('leave-btn').onclick      = () => this.leaveCall();
        this.$('reconnect-btn').onclick  = () => this.forceReconnect();
        this.$('close-cam-modal').onclick= () => this.closeCamModal();
        this.$('cam-modal').onclick      = e => { if (e.target===this.$('cam-modal')) this.closeCamModal(); };
    }

    setupFirebaseMonitor() {
        if (!database) return;
        database.ref('.info/connected').on('value', s => { if (!s.val()) this.showReconnectBanner('Firebase disconnected'); });
    }

    checkUrlForRoom() {
        const r = new URLSearchParams(location.search).get('room');
        if (r && /^\d{4}$/.test(r)) { this.$('room-code').value = r; setTimeout(()=>this.joinRoom(), 600); }
    }

    /* ── Toast / UI helpers ─────────────────────────────── */
    toast(msg, important=false) {
        const t = document.createElement('div');
        t.className = 'toast'+(important?' important':'');
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), important ? 5000 : 2200);
    }
    showLoading(show, msg='Connecting…') { this.loadMsg.textContent=msg; this.loadOverlay.style.display=show?'flex':'none'; }
    showReconnectBanner(msg) { this.reconnectMsgEl.textContent=msg+' '; this.reconnectBanner.classList.add('show'); }
    hideReconnectBanner()    { this.reconnectBanner.classList.remove('show'); }

    /* ── Dynamic grid layout ────────────────────────────── */
    updateGrid() {
        const cards = this.videoGrid.querySelectorAll('.video-container');
        const n = cards.length;
        this.videoGrid.className = '';
        this.gridEmpty.style.display = n === 0 ? 'flex' : 'none';

        if      (n === 0) { /* empty state shown */ }
        else if (n === 1) this.videoGrid.classList.add('layout-1');
        else if (n === 2) this.videoGrid.classList.add('layout-2');
        else if (n === 3) this.videoGrid.classList.add('layout-3');
        else if (n === 4) this.videoGrid.classList.add('layout-4');
        else if (n === 5) this.videoGrid.classList.add('layout-5');
        else              this.videoGrid.classList.add('layout-many');

        this.pCount.textContent = n;
    }

    /* ── Chat counter ───────────────────────────────────── */
    incrementMsgCount() {
        this.totalMessages++;
        this.chatPanelCount.textContent = this.totalMessages;
        if (!this.chatOpen) {
            this.unreadMessages++;
            this.chatBadge.textContent = this.unreadMessages > 99 ? '99+' : this.unreadMessages;
            this.chatBadge.classList.add('show');
        }
    }

    /* ── Control button sync ────────────────────────────── */
    syncCtrlBtns() {
        // Mute
        this.muteBtn.className = 'ctrl-btn ' + (this.isAudioMuted ? 'off' : 'on');
        this.muteBtn.innerHTML = `
            <i data-lucide="${this.isAudioMuted ? 'mic-off' : 'mic'}" style="width:20px;height:20px;"></i>
            <span>${this.isAudioMuted ? 'Unmute' : 'Mic'}</span>`;
        // Video
        this.videoBtn.className = 'ctrl-btn ' + (this.isVideoMuted ? 'off' : 'on');
        this.videoBtn.innerHTML = `
            <i data-lucide="${this.isVideoMuted ? 'video-off' : 'video'}" style="width:20px;height:20px;"></i>
            <span>${this.isVideoMuted ? 'Start Cam' : 'Camera'}</span>`;
        lucide.createIcons();
        // Re-bind after innerHTML replace
        this.muteBtn.onclick  = () => this.toggleAudio();
        this.videoBtn.onclick = () => this.toggleVideo();
    }

    /* ── Room ───────────────────────────────────────────── */
    async createRoom() {
        try {
            this.roomId = Math.floor(1000+Math.random()*9000).toString();
            this.$('current-room').textContent = this.roomId;
            history.pushState({},'',`?room=${this.roomId}`);
            this.showLoading(true,'Creating room…');
            if (database) await database.ref(`rooms/${this.roomId}`).set({ created: Date.now(), createdBy: this.userId });
            await this.initMedia();
            this.landingPage.classList.remove('active');
            this.callPage.classList.add('active');
            lucide.createIcons();
            this.setupFBListeners();
            this.setActiveSession(this.roomId);
            this.startHealthMonitor();
            this.toast(`Room ${this.roomId} created`);
            setTimeout(()=>this.clip(this.roomId,'Room code copied!'), 900);
        } catch(e) { console.error(e); this.toast('Failed to create room'); }
        finally { this.showLoading(false); }
    }

    async joinRoom() {
        const code = this.$('room-code').value.trim();
        if (!/^\d{4}$/.test(code)) { this.toast('Enter a valid 4-digit code'); return; }
        try {
            this.roomId = code;
            this.$('current-room').textContent = code;
            history.pushState({},'',`?room=${code}`);
            this.showLoading(true,'Joining room…');
            if (database) {
                const snap = await database.ref(`rooms/${code}`).once('value');
                if (!snap.exists()) await database.ref(`rooms/${code}`).set({ created: Date.now(), createdBy: this.userId });
            }
            await this.initMedia();
            this.landingPage.classList.remove('active');
            this.callPage.classList.add('active');
            lucide.createIcons();
            this.setupFBListeners();
            this.setActiveSession(code);
            this.startHealthMonitor();
            this.toast(`Joined room ${code}`);
        } catch(e) { console.error(e); this.toast('Failed to join room'); }
        finally { this.showLoading(false); }
    }

    /* ── Media init ─────────────────────────────────────── */
    async buildConstraints(camId=null) {
        const video = camId
            ? { deviceId:{exact:camId}, width:{ideal:1280}, height:{ideal:720} }
            : { width:{ideal:1280}, height:{ideal:720}, facingMode:'user' };
        return { video, audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } };
    }

    async initMedia(camId=null) {
        let stream;
        try { stream = await navigator.mediaDevices.getUserMedia(await this.buildConstraints(camId)); }
        catch(e) { stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true}); }
        if (!stream) throw new Error('No media stream');
        this.localStream = stream;
        this.currentCameraId = camId || stream.getVideoTracks()[0]?.getSettings()?.deviceId;
        const a = stream.getAudioTracks()[0]; const v = stream.getVideoTracks()[0];
        if (a) a.enabled = !this.isAudioMuted;
        if (v) v.enabled = !this.isVideoMuted;
        stream.getTracks().forEach(t => { t.onended = () => this.handleTrackEnded(t.kind); });
        this.addLocalVideo();
        await this.enumerateCameras();
    }

    handleTrackEnded(kind) { this.showReconnectBanner(`${kind} stream ended`); this.attemptReconnect(); }

    startHealthMonitor() {
        if (this.streamHealthInterval) clearInterval(this.streamHealthInterval);
        this.streamHealthInterval = setInterval(() => {
            if (!this.localStream) { this.attemptReconnect(); return; }
            const ok = this.localStream.getTracks().every(t => t.readyState === 'live');
            if (ok) { this.hideReconnectBanner(); this.reconnectAttempts = 0; }
            else    { this.showReconnectBanner('Stream degraded'); this.attemptReconnect(); }
        }, 10000);
    }

    async attemptReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) { this.toast('Stream unrecoverable — please refresh.', true); return; }
        this.reconnectAttempts++;
        if (this.reconnectTimeout) clearTimeout(this.reconnectTimeout);
        this.reconnectTimeout = setTimeout(async () => {
            try { await this.reinitMedia(); } catch(e) { this.attemptReconnect(); }
        }, 2000 * this.reconnectAttempts);
    }

    async forceReconnect() { this.showLoading(true,'Reconnecting…'); this.reconnectAttempts=0; await this.reinitMedia().catch(()=>{}); this.showLoading(false); }

    async reinitMedia() {
        if (this.localStream) this.localStream.getTracks().forEach(t => { try{t.stop();}catch(e){} });
        const s = await navigator.mediaDevices.getUserMedia(await this.buildConstraints(this.currentCameraId));
        const a=s.getAudioTracks()[0]; const v=s.getVideoTracks()[0];
        if (a) a.enabled = !this.isAudioMuted;
        if (v) v.enabled = !this.isVideoMuted;
        s.getTracks().forEach(t => { t.onended = () => this.handleTrackEnded(t.kind); });
        const c = document.getElementById(`container-${this.userId}`);
        if (c) { const vid=c.querySelector('video'); if(vid){vid.srcObject=s;vid.play().catch(()=>{});} }
        this.peers.forEach((peer,pid) => {
            if (peer?._pc) {
                s.getTracks().forEach(t => {
                    const sender = peer._pc.getSenders().find(ss=>ss.track?.kind===t.kind);
                    if (sender) sender.replaceTrack(t).catch(()=>this.reconnectPeer(pid));
                });
            }
        });
        this.localStream = s;
        this.hideReconnectBanner();
        this.toast('Stream recovered');
    }

    reconnectPeer(peerId) {
        const p = this.peers.get(peerId); if(p){try{p.destroy();}catch(e){} this.peers.delete(peerId);}
        if (this.qualityIntervals.has(peerId)){clearInterval(this.qualityIntervals.get(peerId));this.qualityIntervals.delete(peerId);}
        document.getElementById(`container-${peerId}`)?.remove();
        this.updateGrid();
        setTimeout(()=>this.connectToPeer(peerId,true),1000);
    }

    /* ── Camera switch ──────────────────────────────────── */
    openCamModal() {
        const list = this.$('cam-list');
        list.innerHTML = '';
        if (!this.cameras.length) {
            list.innerHTML = '<div style="padding:16px;color:var(--text2);font-size:14px;">No cameras found</div>';
        } else {
            this.cameras.forEach((cam,i) => {
                const isBack = /back|rear|environment/i.test(cam.label);
                const opt = document.createElement('div');
                opt.className = 'cam-opt' + (cam.deviceId===this.currentCameraId ? ' selected' : '');
                opt.innerHTML = `
                    <div class="cam-opt-icon">
                        <i data-lucide="${isBack?'aperture':'camera'}" style="width:18px;height:18px;"></i>
                    </div>
                    <span>${cam.label || `Camera ${i+1}`}</span>`;
                opt.onclick = () => { this.switchCamera(cam.deviceId); this.closeCamModal(); };
                list.appendChild(opt);
            });
        }
        lucide.createIcons();
        this.$('cam-modal').classList.add('open');
    }

    closeCamModal() { this.$('cam-modal').classList.remove('open'); }

    async switchCamera(deviceId) {
        if (deviceId === this.currentCameraId) return;
        this.toast('Switching camera…');
        try {
            const oldVid = this.localStream?.getVideoTracks()[0];
            if (oldVid) oldVid.stop();
            const ns = await navigator.mediaDevices.getUserMedia({ video:{deviceId:{exact:deviceId},width:{ideal:1280},height:{ideal:720}} });
            const newTrack = ns.getVideoTracks()[0];
            if (this.localStream) {
                this.localStream.getVideoTracks().forEach(t=>this.localStream.removeTrack(t));
                this.localStream.addTrack(newTrack);
            }
            const container = document.getElementById(`container-${this.userId}`);
            if (container) { const vid=container.querySelector('video'); if(vid) vid.srcObject=this.localStream; }
            this.peers.forEach(peer => {
                if (peer?._pc) {
                    const sender = peer._pc.getSenders().find(s=>s.track?.kind==='video');
                    if (sender) sender.replaceTrack(newTrack).catch(console.error);
                }
            });
            this.currentCameraId = deviceId;
            newTrack.onended = () => this.handleTrackEnded('video');
            this.toast('Camera switched');
        } catch(e) { console.error(e); this.toast('Failed to switch camera', true); }
    }

    /* ── Local video ─────────────────────────────────────── */
    addLocalVideo() {
        let con = document.getElementById(`container-${this.userId}`);
        if (con) { const v=con.querySelector('video'); if(v){v.srcObject=this.localStream;v.play().catch(()=>{});} return; }

        con = document.createElement('div');
        con.id = `container-${this.userId}`;
        con.className = 'video-container local-video'+(this.isVideoMuted?' video-off':'');

        const video = document.createElement('video');
        video.srcObject=this.localStream; video.autoplay=true; video.playsInline=true; video.muted=true;

        const av = document.createElement('div'); av.className='av-overlay';
        av.innerHTML=`<div class="av-circle">${SVG.user}</div><span style="font-size:12px;color:var(--text2)">You</span>`;

        const nt = document.createElement('div'); nt.className='name-tag';
        nt.innerHTML=`${SVG.user} You`;

        const mb = document.createElement('div');
        mb.className='mute-badge'+(this.isAudioMuted?' muted':'');
        mb.id=`mute-${this.userId}`;
        mb.innerHTML=this.isAudioMuted?SVG.micOff:SVG.mic;

        const pip = document.createElement('button'); pip.className='pip-btn'; pip.innerHTML=SVG.pip;
        pip.onclick = e=>{e.stopPropagation();this.togglePiP(video);};

        con.append(video,av,nt,mb,pip);
        this.videoGrid.appendChild(con);
        video.play().catch(()=>{});
        this.updateGrid();
        this.syncCtrlBtns();
    }

    togglePiP(video) {
        if (document.pictureInPictureElement) document.exitPictureInPicture().catch(()=>{});
        else video.requestPictureInPicture().catch(()=>this.toast('PiP not supported'));
    }

    /* ── Real connection quality ─────────────────────────── */
    async measureQuality(peer, peerId) {
        if (!peer?._pc) return;
        try {
            const stats = await peer._pc.getStats();
            let lost=0, recv=0, rtt=null;
            stats.forEach(r => {
                if (r.type==='inbound-rtp'&&r.mediaType==='video'){lost+=r.packetsLost||0;recv+=r.packetsReceived||0;}
                if (r.type==='candidate-pair'&&r.state==='succeeded'&&r.currentRoundTripTime!=null) rtt=r.currentRoundTripTime*1000;
            });
            const loss=(lost+recv)>0?lost/(lost+recv):0;
            const q = rtt!=null
                ? (rtt<100&&loss<0.01?4:rtt<200&&loss<0.03?3:rtt<400&&loss<0.08?2:1)
                : (loss<0.03?3:loss<0.08?2:1);
            const bar = document.querySelector(`#container-${peerId} .quality-bar`);
            if (bar) bar.setAttribute('data-quality', q);
        } catch(e){}
    }

    /* ── Firebase listeners ──────────────────────────────── */
    setupFBListeners() {
        if (!database || !this.roomId) return;
        const roomRef = database.ref(`rooms/${this.roomId}`);
        const partRef = roomRef.child('participants');
        const msgsRef = roomRef.child('messages');
        const sigRef  = database.ref(`rooms/${this.roomId}/signals`);

        // FIX #1: single listener
        const onAdded = partRef.on('child_added', snap => {
            const pid = snap.key;
            if (pid!==this.userId && !this.peers.has(pid) && this.localStream) {
                setTimeout(()=>{ if(!this.peers.has(pid)) this.connectToPeer(pid,true); }, 500+Math.random()*800);
            }
            this.updateCount(partRef);
        });

        const onRemoved = partRef.on('child_removed', snap => {
            this.removeParticipant(snap.key);
            this.updateCount(partRef);
            this.checkCleanup(roomRef);
        });

        const onMsg = msgsRef.on('child_added', snap => this.displayMessage(snap.val()));

        // FIX #7: 30s cleanup window
        const onSig = sigRef.on('child_added', snap => {
            const sig = snap.val();
            if (sig?.target===this.userId && sig.from!==this.userId) this.handleSignal(sig);
            setTimeout(()=>snap.ref.remove(), 30000);
        });

        this.firebaseListeners = [
            {ref:partRef, event:'child_added',   fn:onAdded},
            {ref:partRef, event:'child_removed',  fn:onRemoved},
            {ref:msgsRef, event:'child_added',    fn:onMsg},
            {ref:sigRef,  event:'child_added',    fn:onSig}
        ];

        const selfRef = partRef.child(this.userId);
        selfRef.set({ timestamp: Date.now(), userId: this.userId });
        selfRef.onDisconnect().remove();
    }

    tearDownListeners() {
        this.firebaseListeners.forEach(({ref,event,fn})=>{ try{ref.off(event,fn);}catch(e){} });
        this.firebaseListeners=[];
    }

    updateCount(partRef) {
        partRef.once('value', s=>{
            const n = s.val() ? Object.keys(s.val()).length : 0;
            this.pCount.textContent = n;
        });
    }

    checkCleanup(roomRef) {
        roomRef.child('participants').once('value', s=>{
            if (!s.exists()||s.numChildren()===0) roomRef.remove().catch(()=>{});
        });
    }

    /* ── Peer connections ────────────────────────────────── */
    connectToPeer(peerId, initiator=false) {
        if (this.peers.has(peerId)||!this.localStream) return;
        const peer = new SimplePeer({
            initiator, stream: this.localStream, trickle: true,
            config: { iceServers:[
                {urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'},
                {urls:'turn:openrelay.metered.ca:80',username:'openrelayproject',credential:'openrelayproject'}
            ]}
        });

        peer.on('signal', sig => {
            if (database&&this.roomId) database.ref(`rooms/${this.roomId}/signals`).push({from:this.userId,target:peerId,signal:sig,timestamp:Date.now()});
        });
        peer.on('stream', stream => this.addRemoteVideo(stream, peerId));
        peer.on('close',  ()     => this.removeParticipant(peerId));
        peer.on('error',  e     => { console.error('Peer err:',e); setTimeout(()=>this.reconnectPeer(peerId),2000); });
        peer.on('connect',()    => {
            this.reconnectAttempts=0;
            // FIX #5 &#6: real stats, stored interval
            const qi = setInterval(()=>this.measureQuality(peer,peerId), 5000);
            this.qualityIntervals.set(peerId, qi);
        });
        peer.on('iceStateChange', state => {
            if (['failed','disconnected'].includes(state)) setTimeout(()=>{ if(!this.peers.has(peerId)) this.reconnectPeer(peerId); },3000);
        });
        this.peers.set(peerId, peer);
    }

    // FIX #8: robust retry
    handleSignal(sig) {
        const pid=sig.from;
        if (!this.peers.has(pid)) {
            this.connectToPeer(pid,false);
            let tries=0;
            const retry=()=>{
                const p=this.peers.get(pid);
                if(p){try{p.signal(sig.signal);}catch(e){}}
                else if(tries++<6) setTimeout(retry,500);
            };
            setTimeout(retry,200);
        } else { try{this.peers.get(pid).signal(sig.signal);}catch(e){} }
    }

    /* ── Remote video ────────────────────────────────────── */
    addRemoteVideo(stream, userId) {
        const ex = document.getElementById(`container-${userId}`);
        if (ex) { const v=ex.querySelector('video'); if(v&&v.srcObject!==stream){v.srcObject=stream;v.play().catch(()=>{});} return; }

        const con = document.createElement('div');
        con.id=`container-${userId}`; con.className='video-container';

        const video=document.createElement('video');
        video.srcObject=stream; video.autoplay=true; video.playsInline=true;

        const av=document.createElement('div'); av.className='av-overlay';
        av.innerHTML=`<div class="av-circle">${SVG.user}</div>`;

        const nt=document.createElement('div'); nt.className='name-tag';
        nt.innerHTML=`${SVG.user} User ${userId.slice(-4)}`;

        const mb=document.createElement('div');
        mb.className='mute-badge'; mb.id=`mute-${userId}`; mb.innerHTML=SVG.mic;

        const qb=document.createElement('div'); qb.className='quality-bar'; qb.setAttribute('data-quality','0');
        for(let i=0;i<4;i++){const b=document.createElement('div');b.className='bar';qb.appendChild(b);}

        const pip=document.createElement('button'); pip.className='pip-btn'; pip.innerHTML=SVG.pip;
        pip.onclick=e=>{e.stopPropagation();this.togglePiP(video);};

        con.append(video,av,nt,mb,qb,pip);
        this.videoGrid.appendChild(con);
        video.play().catch(()=>setTimeout(()=>video.play().catch(()=>{}),800));
        this.updateGrid();
    }

    removeParticipant(userId) {
        const p=this.peers.get(userId); if(p){try{p.destroy();}catch(e){} this.peers.delete(userId);}
        if(this.qualityIntervals.has(userId)){clearInterval(this.qualityIntervals.get(userId));this.qualityIntervals.delete(userId);}
        document.getElementById(`container-${userId}`)?.remove();
        this.updateGrid();
    }

    /* ── Controls ────────────────────────────────────────── */
    toggleAudio() {
        if (!this.localStream) return;
        const t=this.localStream.getAudioTracks()[0]; if(!t) return;
        t.enabled = !t.enabled; this.isAudioMuted = !t.enabled;
        const mb=document.getElementById(`mute-${this.userId}`);
        if(mb){mb.classList.toggle('muted',this.isAudioMuted); mb.innerHTML=this.isAudioMuted?SVG.micOff:SVG.mic;}
        this.syncCtrlBtns(); this.savePrefs();
        this.toast(this.isAudioMuted?'Microphone off':'Microphone on');
    }

    toggleVideo() {
        if (!this.localStream) return;
        const t=this.localStream.getVideoTracks()[0]; if(!t) return;
        t.enabled = !t.enabled; this.isVideoMuted = !t.enabled;
        document.getElementById(`container-${this.userId}`)?.classList.toggle('video-off',this.isVideoMuted);
        this.syncCtrlBtns(); this.savePrefs();
        this.toast(this.isVideoMuted?'Camera off':'Camera on');
    }

    /* ── Chat ────────────────────────────────────────────── */
    toggleChat() {
        this.chatOpen = !this.chatOpen;
        this.chatPanel.classList.toggle('open', this.chatOpen);
        const btn = this.$('toggle-chat-btn');
        if (this.chatOpen) {
            this.unreadMessages=0; this.chatBadge.classList.remove('show'); btn.classList.add('active');
            setTimeout(()=>{ this.chatMessages.scrollTop=this.chatMessages.scrollHeight; },100);
        } else { btn.classList.remove('active'); }
    }

    sendMessage() {
        const text=this.$('chat-input').value.trim();
        if(!text||!database||!this.roomId) return;
        database.ref(`rooms/${this.roomId}/messages`).push({from:this.userId,text,timestamp:Date.now()})
            .then(()=>{ this.$('chat-input').value=''; })
            .catch(()=>this.toast('Failed to send'));
    }

    displayMessage(msg) {
        const own = msg.from===this.userId;
        const div = document.createElement('div');
        div.className='msg'+(own?' own':'');
        const time=new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        div.innerHTML=`
            <div class="msg-sender">${own?'You':'User '+msg.from.slice(-4)}</div>
            <div class="msg-text">${this.escHtml(msg.text)}</div>
            <div class="msg-time">${time}</div>`;
        this.chatMessages.appendChild(div);
        this.chatMessages.scrollTop=this.chatMessages.scrollHeight;
        this.incrementMsgCount();
    }

    escHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

    /* ── Clipboard ───────────────────────────────────────── */
    clip(text, msg) {
        navigator.clipboard.writeText(text).then(()=>this.toast(msg)).catch(()=>{
            const ta=document.createElement('textarea'); ta.value=text;
            document.body.appendChild(ta); ta.select(); document.execCommand('copy');
            document.body.removeChild(ta); this.toast(msg);
        });
    }
    copyLink() {
        const base=`${location.protocol}//${location.hostname}${location.port?':'+location.port:''}${location.pathname}`;
        this.clip(`${base}?room=${this.roomId}`,'Invite link copied!');
    }

    /* ── Leave ───────────────────────────────────────────── */
    async leaveCall() {
        this.showLoading(true,'Leaving…');
        if(this.streamHealthInterval){clearInterval(this.streamHealthInterval);this.streamHealthInterval=null;}
        if(this.reconnectTimeout){clearTimeout(this.reconnectTimeout);this.reconnectTimeout=null;}
        this.qualityIntervals.forEach(id=>clearInterval(id)); this.qualityIntervals.clear();
        this.tearDownListeners();
        this.peers.forEach(p=>{try{p.destroy();}catch(e){}}); this.peers.clear();
        if(this.localStream){this.localStream.getTracks().forEach(t=>{try{t.stop();}catch(e){}});this.localStream=null;}
        if(database&&this.roomId){
            const rr=database.ref(`rooms/${this.roomId}`);
            await rr.child('participants').child(this.userId).remove().catch(()=>{});
            const snap=await rr.child('participants').once('value').catch(()=>null);
            if(!snap?.exists()||snap.numChildren()===0) await rr.remove().catch(()=>{});
        }
        this.clearUserCookies();
        this.videoGrid.innerHTML='';
        this.videoGrid.appendChild(this.gridEmpty);
        this.gridEmpty.style.display='none';
        this.videoGrid.className='layout-1';
        this.chatMessages.innerHTML='';
        this.chatPanel.classList.remove('open');
        this.hideReconnectBanner();
        this.totalMessages=0; this.unreadMessages=0;
        this.chatBadge.classList.remove('show'); this.chatPanelCount.textContent='0';
        history.replaceState({},'',location.pathname);
        this.callPage.classList.remove('active');
        this.landingPage.classList.add('active');
        lucide.createIcons();
        this.showLoading(false);
        this.toast('You left the call');
    }

    handlePageUnload() {
        if(this.roomId&&database){
            database.ref(`rooms/${this.roomId}/participants/${this.userId}`).remove();
            this.clearSessionCookie();
        }
    }
}

window.addEventListener('beforeunload',()=>{ if(window.app) window.app.handlePageUnload(); });

document.addEventListener('DOMContentLoaded',()=>{
    if(typeof SimplePeer==='undefined'){alert('Video library failed to load. Please refresh.');return;}
    lucide.createIcons();
    window.app = new VideoCallApp();
});
</script>
</body>
</html>
